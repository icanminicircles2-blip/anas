<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I CAN - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù†ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <style>
        body { background: linear-gradient(135deg, #004d40, #002f6c); color: white; font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; text-align: center; min-height: 100vh; }
        .container { width: 95%; max-width: 900px; background: rgba(255, 255, 255, 0.15); padding: 20px; border-radius: 20px; backdrop-filter: blur(15px); margin: 20px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .worker-card { background: white; color: #002f6c; padding: 15px; margin: 10px; border-radius: 12px; cursor: pointer; display: inline-block; width: 140px; font-weight: bold; }
        .day-row { display: grid; grid-template-columns: 0.5fr 1.2fr 1.2fr 0.8fr 0.8fr 0.8fr; gap: 8px; background: rgba(255, 255, 255, 0.95); color: #333; margin: 5px 0; padding: 10px; border-radius: 8px; align-items: center; }
        .touch-btn { background: #007bff; color: white; padding: 8px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; font-size: 11px; }
        .locked { background: #ccc !important; cursor: not-allowed; opacity: 0.5; }
        .hidden { display: none; }
        input { padding: 10px; border-radius: 8px; border: none; text-align: center; margin: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .mgr-btn { background: #ffc107; color: black; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="screen-login" class="container">
        <h1>Ù†Ø¸Ø§Ù… I CAN</h1>
        <p>Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø­ÙŠ Ø§Ù„Ø³Ø§Ø¨Ø¹)</p>
        <div id="loginList"></div>
        <button class="btn mgr-btn" onclick="checkManager()">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± âš™ï¸</button>
    </div>

    <div id="screen-admin" class="container hidden">
        <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
            <input type="text" id="newWorkerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø®ØµØ§Ø¦ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <button class="btn" style="background: #28a745; color: white;" onclick="addWorker()">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div id="adminWorkerList" style="margin-top: 20px;"></div>
        <button class="btn" style="background: #666; color: white; margin-top: 20px;" onclick="showScreen('screen-login')">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="screen-days" class="container hidden">
        <h2 id="currentMonthTitle"></h2>
        <div class="day-row" style="background: #002f6c; color: white; font-weight: bold; font-size: 11px;">
            <span>ÙŠÙˆÙ…</span><span>Ø­Ø¶ÙˆØ±</span><span>Ø§Ù†ØµØ±Ø§Ù</span><span>ØªØ£Ø®ÙŠØ±</span><span>Ù…Ø¨ÙƒØ±</span><span>Ø¥Ø¶Ø§ÙÙŠ</span>
        </div>
        <div id="daysList"></div>
        <button class="btn" style="background: #28a745; color: white; width: 100%;" onclick="showScreen('screen-login')">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3dczppftLkPSpsMVsb3GsryyYqDjGgEo",
            authDomain: "ican-5dfb5.firebaseapp.com",
            projectId: "ican-5dfb5",
            storageBucket: "ican-5dfb5.firebasestorage.app",
            messagingSenderId: "471479335646",
            appId: "1:471479335646:web:bdb0adacf9aae88afee04f"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let activeUserId = "";
        let activeUserName = "";

        // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­ÙŠ Ø§Ù„Ø³Ø§Ø¨Ø¹ Ø§Ù„ØªØ¬Ù…Ø¹ Ø§Ù„Ø£ÙˆÙ„ (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)
        const TARGET_LAT = 30.0575; 
        const TARGET_LNG = 31.4650;

        window.showScreen = (id) => {
            document.querySelectorAll('.container').forEach(c => c.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.checkManager = () => {
            if(prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø¯ÙŠØ±:") === "123") showScreen('screen-admin');
            else alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±!");
        };

        window.addWorker = () => {
            const name = document.getElementById('newWorkerName').value.trim();
            if(name) { push(ref(db, 'workers'), { name }); document.getElementById('newWorkerName').value = ""; }
        };

        // Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª (Trash) ÙƒÙ…Ø§ Ø·Ù„Ø¨ØªÙ Ù„Ù„Ù…Ø¯Ø±Ø§Ø¡
        window.deleteWorker = (id, name) => {
            if(confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ${name} ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ù„Ù…Ù‡Ù…Ù„Ø§ØªØŸ`)) {
                set(ref(db, `trash/${id}`), { name, deletedAt: new Date().toISOString() });
                remove(ref(db, `workers/${id}`));
            }
        };

        onValue(ref(db, 'workers'), (snap) => {
            const list = document.getElementById('loginList');
            const adminList = document.getElementById('adminWorkerList');
            list.innerHTML = ""; adminList.innerHTML = "";
            snap.forEach(child => {
                const id = child.key; const name = child.val().name;
                // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ†
                let div = document.createElement('div'); div.className = "worker-card"; div.innerText = name;
                div.onclick = () => loginWorker(id, name);
                list.appendChild(div);
                // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ø·Ù„Ø§Ø¹ ÙˆØ­Ø°Ù)
                let admDiv = document.createElement('div');
                admDiv.style = "background:white; color:black; padding:10px; margin:5px; border-radius:8px; display:flex; justify-content:space-between;";
                admDiv.innerHTML = `<span>${name}</span> <button onclick="deleteWorker('${id}','${name}')" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">Ø­Ø°Ù ğŸ—‘ï¸</button>`;
                adminList.appendChild(admDiv);
            });
        });

        window.loginWorker = (id, name) => {
            const pass = prompt(`Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø£Ø®ØµØ§Ø¦ÙŠ (${name}):`);
            const secret = "Ù…" + name.substring(1); // ØªØºÙŠÙŠØ± Ø£ÙˆÙ„ Ø­Ø±Ù Ù„Ù…ÙŠÙ…
            if(pass === secret) {
                activeUserId = id; activeUserName = name;
                loadDays();
            } else { alert("Ø±Ù…Ø² Ø³Ø±ÙŠ Ø®Ø§Ø·Ø¦!"); }
        };

        window.loadDays = () => {
            const today = new Date();
            const mIdx = today.getMonth() + 1;
            const dayNum = today.getDate();
            document.getElementById('currentMonthTitle').innerText = `Ø³Ø¬Ù„ ${activeUserName} - Ø´Ù‡Ø± ${mIdx}`;
            
            onValue(ref(db, `attendance/${activeUserId}/${mIdx}`), (snap) => {
                const saved = snap.val() || {};
                const list = document.getElementById('daysList');
                list.innerHTML = "";
                for(let i=1; i<=31; i++) {
                    let d = new Date(2026, mIdx-1, i);
                    if(d.getMonth()+1 !== mIdx || d.getDay() === 5 || d.getDay() === 6) continue;
                    
                    const isToday = (i === dayNum);
                    const dData = saved[i] || {};
                    const row = document.createElement('div');
                    row.className = "day-row";
                    row.innerHTML = `
                        <span>${i}</span>
                        <button class="touch-btn ${!isToday ? 'locked' : ''}" onclick="isToday && checkLocation('in', ${i})">${dData.in || 'Ø­Ø¶ÙˆØ±'}</button>
                        <button class="touch-btn ${!isToday ? 'locked' : ''}" onclick="isToday && checkLocation('out', ${i})">${dData.out || 'Ø§Ù†ØµØ±Ø§Ù'}</button>
                        <div style="font-size:10px;">${dData.delay || 0}Ø¯</div>
                        <div style="font-size:10px;">${dData.early || 0}Ø¯</div>
                        <div style="font-size:10px; color:green">+${dData.extra || 0}Ø¯</div>
                    `;
                    list.appendChild(row);
                }
            }, { onlyOnce: true });
            showScreen('screen-days');
        };

        window.checkLocation = (type, day) => {
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (ØªØ¨Ø³ÙŠØ·Ø§Ù‹ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ‚Ø§Ø±Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)
                const dist = Math.sqrt(Math.pow(lat - TARGET_LAT, 2) + Math.pow(lng - TARGET_LNG, 2));
                if(dist < 0.01) { // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­ÙŠ Ø§Ù„Ø³Ø§Ø¨Ø¹ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
                    record(type, day);
                } else {
                    alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¯Ø§Ø®Ù„ Ù…Ù‚Ø± Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„Ø­ÙŠ Ø§Ù„Ø³Ø§Ø¨Ø¹) Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø©!");
                }
            }, () => alert("ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©"));
        };

        function record(type, day) {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');
            const mIdx = now.getMonth() + 1;
            let updates = {};
            if(type === 'in') {
                const limit = new Date(); limit.setHours(8,30,0);
                let delay = now > limit ? Math.floor((now-limit)/60000) : 0;
                updates = { in: timeStr, delay: delay };
            } else {
                const limit = new Date(); limit.setHours(16,30,0);
                let early = now < limit ? Math.floor((limit-now)/60000) : 0;
                let extra = now > limit ? Math.floor((now-limit)/60000) : 0;
                updates = { out: timeStr, early: early, extra: extra };
            }
            update(ref(db, `attendance/${activeUserId}/${mIdx}/${day}`), updates);
            loadDays();
        }
    </script>
</body>
</html>
